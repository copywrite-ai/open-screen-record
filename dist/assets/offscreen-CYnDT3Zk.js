import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as d}from"./index-CFZHzLVB.js";const c=console.log,l=console.error;console.log=(...e)=>{c(...e),chrome.runtime.sendMessage({type:"LOG",level:"log",args:e})};console.error=(...e)=>{l(...e),chrome.runtime.sendMessage({type:"LOG",level:"error",args:e})};console.log("Offscreen document loaded");chrome.runtime.sendMessage({type:"OFFSCREEN_LOADED"});let r=null,n=[];chrome.runtime.onMessage.addListener(async e=>{if(e.type==="START_RECORDING"){console.log("Offscreen: Starting recording...",e);const a=e.streamId;if(!a){console.error("No streamId provided");return}try{const t=await navigator.mediaDevices.getUserMedia({audio:!1,video:{mandatory:{chromeMediaSource:"tab",chromeMediaSourceId:a}}});console.log("Stream obtained:",t.id,"Active:",t.active),t.getVideoTracks().length>0?console.log("Video track state:",t.getVideoTracks()[0].readyState):console.error("No video tracks found in stream!");let s={mimeType:"video/webm;codecs=vp9"};MediaRecorder.isTypeSupported(s.mimeType)||(console.log("VP9 not supported, trying default webm"),s={mimeType:"video/webm"}),MediaRecorder.isTypeSupported(s.mimeType)||(console.log("WebM not supported, letting browser choose"),s=void 0),r=new MediaRecorder(t,s),n=[],r.ondataavailable=o=>{console.log(`Data available: ${o.data.size} bytes`),o.data.size>0&&n.push(o.data)},r.onerror=o=>{console.error("Recorder error:",o)},r.onstop=async()=>{const o=new Blob(n,{type:"video/webm"});console.log(`Recording finished. Chunks: ${n.length}, Total size: ${(o.size/1024).toFixed(2)} KB`),o.size===0&&console.error("Recording failed: Blob size is 0");try{await d("latest-video",o),console.log("Video saved to IndexedDB"),chrome.runtime.sendMessage({type:"RECORDING_SAVED"})}catch(i){console.error("Failed to save video to IndexedDB",i),chrome.runtime.sendMessage({type:"RECORDING_SAVED",error:i})}t.getTracks().forEach(i=>i.stop())},r.start(200),console.log("MediaRecorder started")}catch(t){console.error("Failed to start recording:",t)}}else e.type==="STOP_RECORDING"&&(console.log("Offscreen: Stopping recording..."),r&&r.state!=="inactive"&&(r.requestData(),r.stop()))});
