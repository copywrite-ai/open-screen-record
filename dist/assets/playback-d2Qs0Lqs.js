var P=Object.defineProperty;var D=(h,t,e)=>t in h?P(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var g=(h,t,e)=>D(h,typeof t!="symbol"?t+"":t,e);import{r as c,j as o,c as A,R as F}from"./client-DYDkQYN6.js";import{g as k}from"./index-CFZHzLVB.js";class W{constructor(t,e,i,s=null){g(this,"canvas");g(this,"video");g(this,"metadata");g(this,"ctx");g(this,"camera");g(this,"viewport",null);this.canvas=t,this.video=e,this.metadata=i.sort((l,u)=>l.timestamp-u.timestamp),this.viewport=s,this.ctx=t.getContext("2d"),this.camera={x:t.width/2,y:t.height/2,zoom:.9}}lerp(t,e,i){return t*(1-i)+e*i}getMousePosition(t){if(this.metadata.length===0)return null;let e=this.metadata[0],i=this.metadata[this.metadata.length-1];if(t<=e.timestamp)return{x:e.x,y:e.y};if(t>=i.timestamp)return{x:i.x,y:i.y};for(let a=0;a<this.metadata.length-1;a++)if(this.metadata[a].timestamp<=t&&this.metadata[a+1].timestamp>=t){e=this.metadata[a],i=this.metadata[a+1];break}const s=i.timestamp-e.timestamp;if(s===0)return{x:e.x,y:e.y};const l=(t-e.timestamp)/s;let u=this.lerp(e.x,i.x,l),x=this.lerp(e.y,i.y,l);if(this.viewport&&this.video.videoWidth>0){const a=this.video.videoWidth/this.viewport.width,v=this.video.videoHeight/this.viewport.height;u*=a,x*=v}return{x:u,y:x}}getTargetZoom(t){return this.metadata.find(i=>i.type==="click"&&Math.abs(i.timestamp-t)<800)?1.8:.9}clamp(t,e,i){return Math.max(e,Math.min(i,t))}drawBackground(){if(!this.ctx)return;const t=this.ctx.createLinearGradient(0,0,this.canvas.width,this.canvas.height);t.addColorStop(0,"#0093E9"),t.addColorStop(.5,"#80D0C7"),t.addColorStop(1,"#80D0C7"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}draw(t){if(!this.ctx)return;this.drawBackground();const e=this.getMousePosition(t);this.ctx.save();let i,s;const l=this.getTargetZoom(t);if(this.camera.zoom=this.lerp(this.camera.zoom,l,.05),e){const u=this.canvas.width/this.camera.zoom,x=this.canvas.height/this.camera.zoom;if(this.camera.zoom<1)i=this.canvas.width/2,s=this.canvas.height/2;else{const a=u/2,v=this.canvas.width-u/2,b=x/2,R=this.canvas.height-x/2;i=this.clamp(e.x,a,v),s=this.clamp(e.y,b,R)}}else i=this.canvas.width/2,s=this.canvas.height/2;if(this.camera.x=this.lerp(this.camera.x,i,.08),this.camera.y=this.lerp(this.camera.y,s,.08),this.ctx.translate(this.canvas.width/2,this.canvas.height/2),this.ctx.scale(this.camera.zoom,this.camera.zoom),this.ctx.translate(-this.camera.x,-this.camera.y),this.video.readyState>=2&&(this.ctx.save(),this.ctx.shadowColor="rgba(0, 0, 0, 0.4)",this.ctx.shadowBlur=40,this.ctx.shadowOffsetY=20,this.ctx.drawImage(this.video,0,0,this.canvas.width,this.canvas.height),this.ctx.restore()),e){const u=24/(this.camera.zoom*.5+.5);this.ctx.shadowColor="rgba(0,0,0,0.3)",this.ctx.shadowBlur=8,this.ctx.shadowOffsetY=4,this.ctx.fillStyle="#FF4757",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,u,0,Math.PI*2),this.ctx.fill(),this.ctx.shadowColor="transparent",this.ctx.strokeStyle="white",this.ctx.lineWidth=3,this.ctx.stroke()}this.ctx.restore()}}function $(){var z;const h=c.useRef(null),t=c.useRef(null),e=c.useRef(null),i=c.useRef(),[s,l]=c.useState(!1),[u,x]=c.useState(""),[a,v]=c.useState(null),[b,R]=c.useState(!0),[p,M]=c.useState({width:1280,height:720});c.useEffect(()=>{(async()=>{var n;try{console.log("Loading data from IDB...");const d=await k("latest-video"),f=await k("latest-metadata");if(d){console.log(`Loaded Blob: ${d.size} bytes, type: ${d.type}`);const y=URL.createObjectURL(d);x(y)}else console.error("No blob found in IDB");f?(console.log(`Loaded Metadata: ${Array.isArray(f)?f.length:(n=f.events)==null?void 0:n.length} events`),v(f)):(console.warn("No metadata found, defaulting to empty"),v([]))}catch(d){console.error("Failed to load recording data",d)}finally{R(!1)}})()},[]);const I=()=>{if(t.current){const{videoWidth:r,videoHeight:n}=t.current;r&&n&&(console.log(`Video dimensions loaded: ${r}x${n}`),M({width:r,height:n}))}},[m,E]=c.useState(!1),w=c.useRef(null),j=c.useRef([]);c.useEffect(()=>{if(h.current&&t.current&&a){let r=[],n=null;Array.isArray(a)?r=a:a.events&&(r=a.events,n=a.viewport),console.log("Initializing Renderer with",r.length,"events. Viewport:",n),e.current=new W(h.current,t.current,r,n)}},[a,p]);const S=()=>{s&&e.current&&t.current&&(e.current.draw(t.current.currentTime*1e3),i.current=requestAnimationFrame(S))};c.useEffect(()=>(s&&(i.current=requestAnimationFrame(S)),()=>{i.current&&cancelAnimationFrame(i.current)}),[s]);const C=async()=>{if(!m&&t.current)try{s?t.current.pause():await t.current.play(),l(!s)}catch(r){console.error("Play failed:",r)}},L=async()=>{if(!h.current||!t.current)return;E(!0),l(!0),t.current.currentTime=0;const r=h.current.captureStream(60),n=new MediaRecorder(r,{mimeType:"video/webm;codecs=vp9",videoBitsPerSecond:8e6});w.current=n,j.current=[],n.ondataavailable=d=>{d.data.size>0&&j.current.push(d.data)},n.onstop=()=>{const d=new Blob(j.current,{type:"video/webm"}),f=URL.createObjectURL(d),y=document.createElement("a");y.href=f,y.download=`malu-export-${Date.now()}.webm`,y.click(),E(!1),l(!1)},n.start();try{await t.current.play()}catch(d){console.error("Export play failed:",d),E(!1),l(!1)}},B=()=>{var r;l(!1),m&&w.current&&w.current.state!=="inactive"&&(w.current.stop(),(r=t.current)==null||r.pause())};return b?o.jsx("div",{children:"Loading recording..."}):u?o.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",padding:"20px"},children:[o.jsx("h1",{children:"Malu Editor"}),o.jsxs("div",{style:{background:"#eee",padding:"10px",marginBottom:"10px",fontSize:"12px",fontFamily:"monospace",border:"1px solid #ccc",width:"100%",maxWidth:"1000px"},children:[o.jsx("strong",{children:"Debug Info:"}),o.jsx("br",{}),"Metadata Events: ",a?Array.isArray(a)?a.length:(z=a.events)==null?void 0:z.length:"null",o.jsx("br",{}),"Video Dims: ",p.width," x ",p.height,o.jsx("br",{}),"IDB Check: ",a?"OK":"EMPTY"]}),o.jsxs("div",{style:{marginBottom:"10px",zIndex:100},children:[o.jsx("button",{onClick:C,disabled:m,style:{fontSize:"16px",padding:"8px 16px",cursor:"pointer",opacity:m?.5:1},children:s&&!m?"Stop & Edit":"Play Rendered"}),o.jsx("button",{onClick:L,disabled:m||s,style:{marginLeft:"10px",fontSize:"16px",padding:"8px 16px",cursor:"pointer",opacity:m||s?.5:1},children:m?"Exporting...":"Export to WebM"})]}),o.jsxs("div",{style:{position:"relative",border:"1px solid #ccc",width:1e3,maxWidth:"100%",aspectRatio:`${p.width}/${p.height}`,overflow:"hidden"},children:[o.jsx("video",{ref:t,src:u,controls:!m,crossOrigin:"anonymous",style:{width:"100%",height:"100%",objectFit:"contain",position:"absolute",top:0,left:0,opacity:s?0:1,zIndex:s?-1:1,pointerEvents:s?"none":"auto"},onEnded:B,onLoadedMetadata:I,onError:r=>console.error("Video error:",r)}),o.jsx("canvas",{ref:h,width:p.width,height:p.height,style:{width:"100%",height:"100%",objectFit:"contain",backgroundColor:"#000",position:"absolute",top:0,left:0,zIndex:5,opacity:s?1:0,pointerEvents:s?"auto":"none"}})]}),m&&o.jsx("div",{style:{marginTop:"20px",color:"#666"},children:"Rendering video... do not close this tab."})]}):o.jsx("div",{children:"No recording found. Please record something first."})}A.createRoot(document.getElementById("root")).render(o.jsx(F.StrictMode,{children:o.jsx($,{})}));
