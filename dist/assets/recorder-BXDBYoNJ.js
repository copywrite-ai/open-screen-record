import"./modulepreload-polyfill-B5Qt9EMX.js";import{r as s,j as e,c as b,R as w}from"./client-D7f9BLy3.js";import{s as R}from"./index-CFZHzLVB.js";function j(){const[a,n]=s.useState("setup"),[m,u]=s.useState(""),o=s.useRef(null),i=s.useRef(null),p=s.useRef([]),d=s.useRef(null),c=s.useRef(null);s.useEffect(()=>{const r=new URLSearchParams(window.location.search).get("targetTabId");if(r){const h=parseInt(r,10);o.current=h}},[]);const g=()=>(c.current||(console.log("Starting metadata sync..."),c.current=new Promise(t=>{chrome.runtime.sendMessage({type:"BROADCAST_STOP",targetTabId:o.current},r=>{console.log("Metadata sync response:",r),t()})})),c.current),x=async()=>{try{const t=await navigator.mediaDevices.getDisplayMedia({video:{width:3840,height:2160},audio:!1});d.current=t,t.getVideoTracks()[0].onended=()=>{i.current&&i.current.state!=="inactive"?g():n("setup")},n("ready")}catch(t){console.error(t),t.name!=="NotAllowedError"&&(u(t.message||"Failed to setup stream"),n("error"))}},y=async()=>{if(d.current)try{if(o.current){await chrome.tabs.update(o.current,{active:!0});const r=await chrome.tabs.get(o.current);r.windowId&&await chrome.windows.update(r.windowId,{focused:!0})}const t=new MediaRecorder(d.current,{mimeType:"video/webm;codecs=vp9",videoBitsPerSecond:8e6});i.current=t,p.current=[],c.current=null,t.ondataavailable=r=>{r.data.size>0&&p.current.push(r.data)},t.onstop=async()=>{n("saving"),c.current||(console.log("onstop called but sync not started, starting now..."),g()),await c.current;const r=new Blob(p.current,{type:"video/webm"});console.log(`Recording finished. Size: ${r.size}`),r.size>0?(await R("latest-video",r),chrome.runtime.sendMessage({type:"RECORDING_FINISHED"}),window.open("playback.html","_blank"),window.close()):(u("Recording failed: No data"),n("error")),d.current&&d.current.getTracks().forEach(h=>h.stop())},t.start(200),n("recording"),chrome.runtime.sendMessage({type:"BROADCAST_START",targetTabId:o.current})}catch(t){console.error(t),u(t.message||"Failed to start"),n("error")}},f=async()=>{g(),i.current&&i.current.state!=="inactive"&&(i.current.requestData(),i.current.stop())};return e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100vh",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',background:"#f5f5f7"},children:[e.jsxs("div",{style:{background:"white",padding:"40px",borderRadius:"12px",boxShadow:"0 4px 20px rgba(0,0,0,0.1)",textAlign:"center",maxWidth:"400px",width:"100%"},children:[e.jsx("h2",{style:{marginTop:0,marginBottom:"20px"},children:"Malu Recorder"}),a==="setup"&&e.jsxs("div",{children:[e.jsxs("p",{style:{marginBottom:"24px",color:"#666"},children:["Select the window or screen you want to record.",e.jsx("br",{}),e.jsxs("span",{style:{fontSize:"10px",color:"#ccc"},children:["Target Tab: ",o.current]})]}),e.jsx("button",{onClick:x,style:l,children:"Select Source"})]}),a==="ready"&&e.jsxs("div",{children:[e.jsxs("div",{style:{marginBottom:"24px"},children:[e.jsx("div",{style:{width:60,height:60,borderRadius:"50%",background:"#e5e5ea",margin:"0 auto 10px",display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx("div",{style:{width:30,height:30,borderRadius:"50%",background:"#34c759"}})}),e.jsx("p",{style:{fontWeight:500},children:"Source Selected"})]}),e.jsx("button",{onClick:y,style:{...l,background:"#FF3B30"},children:"Start Recording"}),e.jsx("button",{onClick:()=>n("setup"),style:{...S,marginTop:"10px"},children:"Change Source"})]}),a==="recording"&&e.jsxs("div",{children:[e.jsx("div",{style:{width:20,height:20,borderRadius:"50%",background:"#FF3B30",margin:"0 auto 10px",animation:"pulse 1s infinite"}}),e.jsx("p",{children:"Recording in progress..."}),e.jsx("p",{style:{fontSize:"12px",color:"#999"},children:"Switch back to this tab to stop."}),e.jsx("button",{onClick:f,style:{...l,background:"#333",marginTop:"20px"},children:"Stop Recording"})]}),a==="saving"&&e.jsxs("div",{children:[e.jsx("div",{className:"spinner"}),e.jsx("p",{children:"Processing recording..."})]}),a==="error"&&e.jsxs("div",{style:{color:"#FF3B30"},children:[e.jsxs("p",{children:["Error: ",m]}),e.jsx("button",{onClick:()=>n("setup"),style:l,children:"Try Again"})]})]}),e.jsx("style",{children:`
        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(0.95); opacity: 1; }
        }
      `})]})}const l={padding:"12px 24px",fontSize:"16px",fontWeight:600,cursor:"pointer",background:"#007AFF",color:"white",border:"none",borderRadius:"8px",width:"100%",transition:"transform 0.1s"},S={padding:"8px",fontSize:"14px",cursor:"pointer",background:"transparent",color:"#007AFF",border:"none",width:"100%"};b.createRoot(document.getElementById("root")).render(e.jsx(w.StrictMode,{children:e.jsx(j,{})}));
