import{s as n}from"./index-CFZHzLVB.js";typeof chrome<"u"&&chrome.action&&chrome.action.onClicked.addListener(async e=>{e.id&&await chrome.tabs.create({url:`recorder.html?targetTabId=${e.id}`,active:!0,pinned:!0})});chrome.runtime.onMessage.addListener((e,s,c)=>{if(e.type==="BROADCAST_START"){const t=e.targetTabId;t&&(console.log(`Broadcasting START to tab ${t}`),(async()=>{try{await chrome.tabs.sendMessage(t,{type:"START_RECORDING"})}catch(o){console.warn("Initial connect failed, attempting injection...",o);try{await chrome.scripting.executeScript({target:{tabId:t},files:["src/content/content-script.ts"]}),await new Promise(r=>setTimeout(r,100)),await chrome.tabs.sendMessage(t,{type:"START_RECORDING"}),console.log("Injection and retry successful")}catch(r){console.error("Failed to inject or retry content script",r)}}})())}if(e.type==="BROADCAST_STOP"){const t=e.targetTabId;if(t)return console.log(`Broadcasting STOP to tab ${t}`),(async()=>{try{const a=await new Promise(o=>{chrome.tabs.sendMessage(t,{type:"STOP_RECORDING"},r=>{chrome.runtime.lastError?(console.warn("Error fetching metadata:",chrome.runtime.lastError),o(null)):o(r)})});a&&a.data?(console.log("Metadata received via broadcast, saving...",a.data.length),await n("latest-metadata",a.data)):(console.log("No metadata received."),await n("latest-metadata",[])),c({success:!0})}catch(a){console.error("Error in BROADCAST_STOP handler:",a),c({success:!1})}})(),!0;console.warn("BROADCAST_STOP received but no targetTabId provided"),c({success:!1,error:"No targetTabId"})}});
