var R=Object.defineProperty;var j=(n,t,e)=>t in n?R(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var h=(n,t,e)=>j(n,typeof t!="symbol"?t+"":t,e);import"./modulepreload-polyfill-B5Qt9EMX.js";import{r as o,j as s,c as S,R as z}from"./client-D7f9BLy3.js";import{g as v}from"./index-CFZHzLVB.js";class E{constructor(t,e,a){h(this,"canvas");h(this,"video");h(this,"metadata");h(this,"ctx");h(this,"camera",{x:0,y:0,zoom:1});this.canvas=t,this.video=e,this.metadata=a.sort((i,c)=>i.timestamp-c.timestamp),this.ctx=t.getContext("2d"),a.length>0&&(this.camera.x=a[0].x,this.camera.y=a[0].y)}lerp(t,e,a){return t*(1-a)+e*a}getMousePosition(t){if(this.metadata.length===0)return null;let e=this.metadata[0],a=this.metadata[this.metadata.length-1];if(t<=e.timestamp)return{x:e.x,y:e.y};if(t>=a.timestamp)return{x:a.x,y:a.y};for(let r=0;r<this.metadata.length-1;r++)if(this.metadata[r].timestamp<=t&&this.metadata[r+1].timestamp>=t){e=this.metadata[r],a=this.metadata[r+1];break}const i=a.timestamp-e.timestamp;if(i===0)return{x:e.x,y:e.y};const c=(t-e.timestamp)/i;return{x:this.lerp(e.x,a.x,c),y:this.lerp(e.y,a.y,c)}}getTargetZoom(t){return this.metadata.find(a=>a.type==="click"&&Math.abs(a.timestamp-t)<800)?2.5:1.5}clamp(t,e,a){return Math.max(e,Math.min(a,t))}draw(t){if(!this.ctx)return;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const e=this.getMousePosition(t);if(this.ctx.save(),e){const a=this.getTargetZoom(t);this.camera.zoom=this.lerp(this.camera.zoom,a,.05);const i=this.canvas.width/this.camera.zoom,c=this.canvas.height/this.camera.zoom,r=i/2,x=this.canvas.width-i/2,l=c/2,m=this.canvas.height-c/2,f=this.clamp(e.x,r,x),g=this.clamp(e.y,l,m);this.camera.x=this.lerp(this.camera.x,f,.1),this.camera.y=this.lerp(this.camera.y,g,.1),this.ctx.translate(this.canvas.width/2,this.canvas.height/2),this.ctx.scale(this.camera.zoom,this.camera.zoom),this.ctx.translate(-this.camera.x,-this.camera.y)}this.video.readyState>=2&&this.ctx.drawImage(this.video,0,0,this.canvas.width,this.canvas.height),e&&(this.ctx.fillStyle="rgba(255, 0, 0, 0.8)",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,15,0,Math.PI*2),this.ctx.fill(),this.ctx.strokeStyle="white",this.ctx.lineWidth=3,this.ctx.stroke()),this.ctx.restore()}}function I(){const n=o.useRef(null),t=o.useRef(null),e=o.useRef(null),a=o.useRef(),[i,c]=o.useState(!1),[r,x]=o.useState(""),[l,m]=o.useState(null),[f,g]=o.useState(!0);o.useEffect(()=>{(async()=>{try{console.log("Loading data from IDB...");const d=await v("latest-video"),p=await v("latest-metadata");if(d){console.log(`Loaded Blob: ${d.size} bytes, type: ${d.type}`);const w=URL.createObjectURL(d);x(w)}else console.error("No blob found in IDB");p?(console.log(`Loaded Metadata: ${p.length} events`),m(p)):(console.warn("No metadata found, defaulting to empty"),m([]))}catch(d){console.error("Failed to load recording data",d)}finally{g(!1)}})()},[]),o.useEffect(()=>{n.current&&t.current&&l&&(console.log("Initializing Renderer with",l.length,"events"),e.current=new E(n.current,t.current,l))},[l]);const y=()=>{i&&e.current&&t.current&&(Math.random()<.02&&console.log("Render loop:",{currentTime:t.current.currentTime,readyState:t.current.readyState,videoWidth:t.current.videoWidth,paused:t.current.paused}),e.current.draw(t.current.currentTime*1e3),a.current=requestAnimationFrame(y))};o.useEffect(()=>(i&&(a.current=requestAnimationFrame(y)),()=>{a.current&&cancelAnimationFrame(a.current)}),[i]);const b=async()=>{if(t.current)try{i?t.current.pause():(console.log("Attempting to play video..."),await t.current.play(),console.log("Video playing!")),c(!i)}catch(u){console.error("Play failed:",u)}};return f?s.jsx("div",{children:"Loading recording..."}):r?s.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",padding:"20px"},children:[s.jsx("h1",{children:"Malu Editor"}),s.jsxs("div",{style:{marginBottom:"10px",zIndex:100},children:[s.jsx("button",{onClick:b,style:{fontSize:"16px",padding:"8px 16px",cursor:"pointer"},children:i?"Stop & Edit":"Play Rendered"}),s.jsx("button",{style:{marginLeft:"10px",fontSize:"16px",padding:"8px 16px"},children:"Export"})]}),s.jsxs("div",{style:{position:"relative",border:"1px solid #ccc",width:1280,height:720,overflow:"hidden"},children:[s.jsx("video",{ref:t,src:r,controls:!0,crossOrigin:"anonymous",style:{width:"100%",height:"100%",objectFit:"contain",position:"absolute",top:0,left:0,opacity:1,zIndex:i?10:1,transform:i?"scale(0.2)":"none",transformOrigin:"top right"},onEnded:()=>c(!1),onLoadedData:()=>console.log("Video loaded data"),onError:u=>console.error("Video error:",u)}),s.jsx("canvas",{ref:n,width:1280,height:720,style:{width:"100%",height:"100%",objectFit:"contain",backgroundColor:"#000",position:"absolute",top:0,left:0,zIndex:5}})]})]}):s.jsx("div",{children:"No recording found. Please record something first."})}S.createRoot(document.getElementById("root")).render(s.jsx(z.StrictMode,{children:s.jsx(I,{})}));
