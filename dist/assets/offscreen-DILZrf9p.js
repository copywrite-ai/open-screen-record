import"./modulepreload-polyfill-B5Qt9EMX.js";import{s as h}from"./index-CFZHzLVB.js";const u=console.log,y=console.error;console.log=(...o)=>{u(...o),chrome.runtime.sendMessage({type:"LOG",level:"log",args:o})};console.error=(...o)=>{y(...o),chrome.runtime.sendMessage({type:"LOG",level:"error",args:o})};console.log("Offscreen document loaded");chrome.runtime.sendMessage({type:"OFFSCREEN_LOADED"});let t=null,a=[];chrome.runtime.onMessage.addListener(async o=>{if(o.type==="START_RECORDING"){console.log("Offscreen: Starting recording...",o);const c=o.streamId;if(!c){console.error("No streamId provided");return}try{const i=o.source==="desktop",s={audio:!1,video:{mandatory:{chromeMediaSource:i?"desktop":"tab",chromeMediaSourceId:c}}};if(!i&&o.dimensions){const{width:e,height:r,dpr:g}=o.dimensions,m=Math.round(e*g),p=Math.round(r*g);s.video.mandatory.minWidth=m,s.video.mandatory.minHeight=p,s.video.mandatory.maxWidth=m,s.video.mandatory.maxHeight=p}console.log(`Requesting stream (${i?"desktop":"tab"})...`);const n=await navigator.mediaDevices.getUserMedia(s);console.log("Stream obtained:",n.id,"Active:",n.active);const l=n.getVideoTracks()[0];if(l){const e=l.getSettings();console.log(`Track settings: ${e.width}x${e.height}`)}let d={mimeType:"video/webm;codecs=vp9"};MediaRecorder.isTypeSupported(d.mimeType)||(console.log("VP9 not supported, trying default webm"),d={mimeType:"video/webm"}),MediaRecorder.isTypeSupported(d.mimeType)||(console.log("WebM not supported, letting browser choose"),d=void 0),t=new MediaRecorder(n,d),a=[],t.ondataavailable=e=>{console.log(`Data available: ${e.data.size} bytes`),e.data.size>0&&a.push(e.data)},t.onerror=e=>{console.error("Recorder error:",e)},t.onstop=async()=>{const e=new Blob(a,{type:"video/webm"});console.log(`Recording finished. Chunks: ${a.length}, Total size: ${(e.size/1024).toFixed(2)} KB`),e.size===0&&console.error("Recording failed: Blob size is 0");try{await h("latest-video",e),console.log("Video saved to IndexedDB"),chrome.runtime.sendMessage({type:"RECORDING_SAVED"})}catch(r){console.error("Failed to save video to IndexedDB",r),chrome.runtime.sendMessage({type:"RECORDING_SAVED",error:r})}n.getTracks().forEach(r=>r.stop())},t.start(200),console.log("MediaRecorder started")}catch(i){console.error("Failed to start recording:",i)}}else o.type==="STOP_RECORDING"&&(console.log("Offscreen: Stopping recording..."),t&&t.state!=="inactive"&&(t.requestData(),t.stop()))});
