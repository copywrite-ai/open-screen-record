import{s as d}from"./index-CFZHzLVB.js";typeof chrome<"u"&&chrome.action&&chrome.action.onClicked.addListener(async e=>{e.id&&await chrome.tabs.create({url:`recorder.html?targetTabId=${e.id}`,active:!0,pinned:!0})});chrome.runtime.onMessage.addListener((e,T,c)=>{if(e.type==="BROADCAST_START"){const t=e.targetTabId;t&&(console.log(`Broadcasting START to tab ${t}`),(async()=>{var r,o,s;try{await chrome.tabs.sendMessage(t,{type:"START_RECORDING"})}catch(l){console.warn("Initial connect failed, attempting injection...",l);try{const n=(s=(o=(r=chrome.runtime.getManifest().content_scripts)==null?void 0:r[0])==null?void 0:o.js)==null?void 0:s[0];n?(await chrome.scripting.executeScript({target:{tabId:t},files:[n]}),await new Promise(m=>setTimeout(m,100)),await chrome.tabs.sendMessage(t,{type:"START_RECORDING"}),console.log("Injection and retry successful with:",n)):console.error("Could not find content script in manifest")}catch(i){console.error("Failed to inject or retry content script",i)}}})())}if(e.type==="BROADCAST_STOP"){const t=e.targetTabId;if(t)return console.log(`Broadcasting STOP to tab ${t}`),(async()=>{try{const a=await new Promise(r=>{chrome.tabs.sendMessage(t,{type:"STOP_RECORDING"},o=>{chrome.runtime.lastError?(console.warn("Error fetching metadata:",chrome.runtime.lastError),r(null)):r(o)})});a&&a.data?(console.log("Metadata received via broadcast, saving...",a.data.length),await d("latest-metadata",a.data)):(console.log("No metadata received."),await d("latest-metadata",[])),c({success:!0})}catch(a){console.error("Error in BROADCAST_STOP handler:",a),c({success:!1})}})(),!0;console.warn("BROADCAST_STOP received but no targetTabId provided"),c({success:!1,error:"No targetTabId"})}});
