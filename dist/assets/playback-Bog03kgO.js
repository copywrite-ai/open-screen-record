var z=Object.defineProperty;var E=(c,t,e)=>t in c?z(c,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):c[t]=e;var x=(c,t,e)=>E(c,typeof t!="symbol"?t+"":t,e);import"./modulepreload-polyfill-B5Qt9EMX.js";import{r,j as a,c as k,R as C}from"./client-D7f9BLy3.js";import{g as w}from"./index-CFZHzLVB.js";class I{constructor(t,e,i){x(this,"canvas");x(this,"video");x(this,"metadata");x(this,"ctx");x(this,"camera");this.canvas=t,this.video=e,this.metadata=i.sort((s,d)=>s.timestamp-d.timestamp),this.ctx=t.getContext("2d"),this.camera={x:t.width/2,y:t.height/2,zoom:.9}}lerp(t,e,i){return t*(1-i)+e*i}getMousePosition(t){if(this.metadata.length===0)return null;let e=this.metadata[0],i=this.metadata[this.metadata.length-1];if(t<=e.timestamp)return{x:e.x,y:e.y};if(t>=i.timestamp)return{x:i.x,y:i.y};for(let o=0;o<this.metadata.length-1;o++)if(this.metadata[o].timestamp<=t&&this.metadata[o+1].timestamp>=t){e=this.metadata[o],i=this.metadata[o+1];break}const s=i.timestamp-e.timestamp;if(s===0)return{x:e.x,y:e.y};const d=(t-e.timestamp)/s;return{x:this.lerp(e.x,i.x,d),y:this.lerp(e.y,i.y,d)}}getTargetZoom(t){return this.metadata.find(i=>i.type==="click"&&Math.abs(i.timestamp-t)<800)?1.8:.9}clamp(t,e,i){return Math.max(e,Math.min(i,t))}drawBackground(){if(!this.ctx)return;const t=this.ctx.createLinearGradient(0,0,this.canvas.width,this.canvas.height);t.addColorStop(0,"#0093E9"),t.addColorStop(.5,"#80D0C7"),t.addColorStop(1,"#80D0C7"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}draw(t){if(!this.ctx)return;this.drawBackground();const e=this.getMousePosition(t);this.ctx.save();let i,s;const d=this.getTargetZoom(t);if(this.camera.zoom=this.lerp(this.camera.zoom,d,.05),e){const o=this.canvas.width/this.camera.zoom,u=this.canvas.height/this.camera.zoom;if(this.camera.zoom<1)i=this.canvas.width/2,s=this.canvas.height/2;else{const n=o/2,g=this.canvas.width-o/2,f=u/2,p=this.canvas.height-u/2;i=this.clamp(e.x,n,g),s=this.clamp(e.y,f,p)}}else i=this.canvas.width/2,s=this.canvas.height/2;if(this.camera.x=this.lerp(this.camera.x,i,.08),this.camera.y=this.lerp(this.camera.y,s,.08),this.ctx.translate(this.canvas.width/2,this.canvas.height/2),this.ctx.scale(this.camera.zoom,this.camera.zoom),this.ctx.translate(-this.camera.x,-this.camera.y),this.video.readyState>=2&&(this.ctx.save(),this.ctx.shadowColor="rgba(0, 0, 0, 0.4)",this.ctx.shadowBlur=40,this.ctx.shadowOffsetY=20,this.ctx.drawImage(this.video,0,0,this.canvas.width,this.canvas.height),this.ctx.restore()),e){const o=24/(this.camera.zoom*.5+.5);this.ctx.shadowColor="rgba(0,0,0,0.3)",this.ctx.shadowBlur=8,this.ctx.shadowOffsetY=4,this.ctx.fillStyle="#FF4757",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,o,0,Math.PI*2),this.ctx.fill(),this.ctx.shadowColor="transparent",this.ctx.strokeStyle="white",this.ctx.lineWidth=3,this.ctx.stroke()}this.ctx.restore()}}function M(){const c=r.useRef(null),t=r.useRef(null),e=r.useRef(null),i=r.useRef(),[s,d]=r.useState(!1),[o,u]=r.useState(""),[n,g]=r.useState(null),[f,p]=r.useState(!0),[m,b]=r.useState({width:1280,height:720});r.useEffect(()=>{(async()=>{try{console.log("Loading data from IDB...");const h=await w("latest-video"),y=await w("latest-metadata");if(h){console.log(`Loaded Blob: ${h.size} bytes, type: ${h.type}`);const R=URL.createObjectURL(h);u(R)}else console.error("No blob found in IDB");y?(console.log(`Loaded Metadata: ${y.length} events`),g(y)):(console.warn("No metadata found, defaulting to empty"),g([]))}catch(h){console.error("Failed to load recording data",h)}finally{p(!1)}})()},[]);const j=()=>{if(t.current){const{videoWidth:l,videoHeight:h}=t.current;l&&h&&(console.log(`Video dimensions loaded: ${l}x${h}`),b({width:l,height:h}))}};r.useEffect(()=>{c.current&&t.current&&n&&(console.log("Initializing Renderer with",n.length,"events"),e.current=new I(c.current,t.current,n))},[n,m]);const v=()=>{s&&e.current&&t.current&&(e.current.draw(t.current.currentTime*1e3),i.current=requestAnimationFrame(v))};r.useEffect(()=>(s&&(i.current=requestAnimationFrame(v)),()=>{i.current&&cancelAnimationFrame(i.current)}),[s]);const S=async()=>{if(t.current)try{s?t.current.pause():await t.current.play(),d(!s)}catch(l){console.error("Play failed:",l)}};return f?a.jsx("div",{children:"Loading recording..."}):o?a.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",padding:"20px"},children:[a.jsx("h1",{children:"Malu Editor"}),a.jsxs("div",{style:{background:"#eee",padding:"10px",marginBottom:"10px",fontSize:"12px",fontFamily:"monospace",border:"1px solid #ccc",width:"100%",maxWidth:"1000px"},children:[a.jsx("strong",{children:"Debug Info:"}),a.jsx("br",{}),"Metadata Events: ",n?n.length:"null",a.jsx("br",{}),"Video Dims: ",m.width," x ",m.height,a.jsx("br",{}),"IDB Check: ",(n==null?void 0:n.length)===0?"EMPTY (Check Console)":"OK"]}),a.jsxs("div",{style:{marginBottom:"10px",zIndex:100},children:[a.jsx("button",{onClick:S,style:{fontSize:"16px",padding:"8px 16px",cursor:"pointer"},children:s?"Stop & Edit":"Play Rendered"}),a.jsx("button",{style:{marginLeft:"10px",fontSize:"16px",padding:"8px 16px"},children:"Export"})]}),a.jsxs("div",{style:{position:"relative",border:"1px solid #ccc",width:1e3,maxWidth:"100%",aspectRatio:`${m.width}/${m.height}`,overflow:"hidden"},children:[a.jsx("video",{ref:t,src:o,controls:!0,crossOrigin:"anonymous",style:{width:"100%",height:"100%",objectFit:"contain",position:"absolute",top:0,left:0,opacity:s?0:1,zIndex:s?-1:1,pointerEvents:s?"none":"auto"},onEnded:()=>d(!1),onLoadedMetadata:j,onError:l=>console.error("Video error:",l)}),a.jsx("canvas",{ref:c,width:m.width,height:m.height,style:{width:"100%",height:"100%",objectFit:"contain",backgroundColor:"#000",position:"absolute",top:0,left:0,zIndex:5,opacity:s?1:0,pointerEvents:s?"auto":"none"}})]})]}):a.jsx("div",{children:"No recording found. Please record something first."})}k.createRoot(document.getElementById("root")).render(a.jsx(C.StrictMode,{children:a.jsx(M,{})}));
