var F=Object.defineProperty;var L=(c,e,i)=>e in c?F(c,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):c[e]=i;var m=(c,e,i)=>L(c,typeof e!="symbol"?e+"":e,i);import{r as n,j as t,c as D,R as W}from"./client-DYDkQYN6.js";import{g as z}from"./index-CFZHzLVB.js";class H{constructor(e,i,s,o=null){m(this,"canvas");m(this,"video");m(this,"metadata");m(this,"ctx");m(this,"camera");m(this,"viewport",null);this.canvas=e,this.video=i,this.metadata=s.sort((h,p)=>h.timestamp-p.timestamp),this.viewport=o,this.ctx=e.getContext("2d"),this.camera={x:e.width/2,y:e.height/2,zoom:.9}}lerp(e,i,s){return e*(1-s)+i*s}getMousePosition(e){if(this.metadata.length===0)return null;let i=this.metadata[0],s=this.metadata[this.metadata.length-1];if(e<=i.timestamp)return{x:i.x,y:i.y};if(e>=s.timestamp)return{x:s.x,y:s.y};for(let a=0;a<this.metadata.length-1;a++)if(this.metadata[a].timestamp<=e&&this.metadata[a+1].timestamp>=e){i=this.metadata[a],s=this.metadata[a+1];break}const o=s.timestamp-i.timestamp;if(o===0)return{x:i.x,y:i.y};const h=(e-i.timestamp)/o;let p=this.lerp(i.x,s.x,h),u=this.lerp(i.y,s.y,h);if(this.viewport&&this.video.videoWidth>0){const a=this.video.videoWidth/this.viewport.width,f=this.video.videoHeight/this.viewport.height;p*=a,u*=f}return{x:p,y:u}}getTargetZoom(e){return this.metadata.find(s=>s.type==="click"&&Math.abs(s.timestamp-e)<800)?1.8:.9}clamp(e,i,s){return Math.max(i,Math.min(s,e))}drawBackground(){if(!this.ctx)return;const e=this.ctx.createLinearGradient(0,0,this.canvas.width,this.canvas.height);e.addColorStop(0,"#0093E9"),e.addColorStop(.5,"#80D0C7"),e.addColorStop(1,"#80D0C7"),this.ctx.fillStyle=e,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}draw(e){if(!this.ctx)return;this.drawBackground();const i=this.getMousePosition(e);this.ctx.save();let s,o;const h=this.getTargetZoom(e);if(this.camera.zoom=this.lerp(this.camera.zoom,h,.05),i){const p=this.canvas.width/this.camera.zoom,u=this.canvas.height/this.camera.zoom;if(this.camera.zoom<1)s=this.canvas.width/2,o=this.canvas.height/2;else{const a=p/2,f=this.canvas.width-p/2,w=u/2,b=this.canvas.height-u/2;s=this.clamp(i.x,a,f),o=this.clamp(i.y,w,b)}}else s=this.canvas.width/2,o=this.canvas.height/2;if(this.camera.x=this.lerp(this.camera.x,s,.08),this.camera.y=this.lerp(this.camera.y,o,.08),this.ctx.translate(this.canvas.width/2,this.canvas.height/2),this.ctx.scale(this.camera.zoom,this.camera.zoom),this.ctx.translate(-this.camera.x,-this.camera.y),this.video.readyState>=2&&(this.ctx.save(),this.ctx.shadowColor="rgba(0, 0, 0, 0.4)",this.ctx.shadowBlur=40,this.ctx.shadowOffsetY=20,this.ctx.drawImage(this.video,0,0,this.canvas.width,this.canvas.height),this.ctx.restore()),i){const p=24/(this.camera.zoom*.5+.5);this.ctx.shadowColor="rgba(0,0,0,0.3)",this.ctx.shadowBlur=8,this.ctx.shadowOffsetY=4,this.ctx.fillStyle="#FF4757",this.ctx.beginPath(),this.ctx.arc(i.x,i.y,p,0,Math.PI*2),this.ctx.fill(),this.ctx.shadowColor="transparent",this.ctx.strokeStyle="white",this.ctx.lineWidth=3,this.ctx.stroke()}this.ctx.restore()}}const V=()=>t.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:t.jsx("path",{d:"M8 5v14l11-7z"})}),Y=()=>t.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"currentColor",children:t.jsx("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z"})}),O=()=>t.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:t.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"})});function U(){const c=n.useRef(null),e=n.useRef(null),i=n.useRef(null),s=n.useRef(),[o,h]=n.useState(!1),[p,u]=n.useState(""),[a,f]=n.useState(null),[w,b]=n.useState(!0),[g,E]=n.useState({width:1280,height:720}),[I,B]=n.useState(0),[y,j]=n.useState(!1),v=n.useRef(null),k=n.useRef([]);n.useEffect(()=>{(async()=>{try{const l=await z("latest-video"),x=await z("latest-metadata");if(l){const S=URL.createObjectURL(l);u(S)}f(x||[])}catch(l){console.error("Failed to load recording data",l)}finally{b(!1)}})()},[]);const M=()=>{if(e.current){const{videoWidth:d,videoHeight:l}=e.current;d&&l&&E({width:d,height:l})}};n.useEffect(()=>{if(c.current&&e.current&&a){let d=[],l=null;Array.isArray(a)?d=a:a.events&&(d=a.events,l=a.viewport),i.current=new H(c.current,e.current,d,l)}},[a,g]);const C=()=>{o&&i.current&&e.current&&(i.current.draw(e.current.currentTime*1e3),B(e.current.currentTime),s.current=requestAnimationFrame(C))};n.useEffect(()=>(o&&(s.current=requestAnimationFrame(C)),()=>{s.current&&cancelAnimationFrame(s.current)}),[o]);const T=async()=>{if(!y&&e.current)try{o?e.current.pause():await e.current.play(),h(!o)}catch(d){console.error("Play failed:",d)}},A=async()=>{if(!c.current||!e.current)return;j(!0),h(!0),e.current.currentTime=0;const d=c.current.captureStream(60),l=new MediaRecorder(d,{mimeType:"video/webm;codecs=vp9",videoBitsPerSecond:8e6});v.current=l,k.current=[],l.ondataavailable=x=>{x.data.size>0&&k.current.push(x.data)},l.onstop=()=>{const x=new Blob(k.current,{type:"video/webm"}),S=URL.createObjectURL(x),R=document.createElement("a");R.href=S,R.download=`malu-export-${Date.now()}.webm`,R.click(),j(!1),h(!1)},l.start();try{await e.current.play()}catch(x){console.error("Export play failed:",x),j(!1),h(!1)}},P=()=>{var d;h(!1),y&&v.current&&v.current.state!=="inactive"&&(v.current.stop(),(d=e.current)==null||d.pause())};return w?t.jsx("div",{style:r.loading,children:"Loading..."}):p?t.jsxs("div",{style:r.container,children:[t.jsxs("header",{style:r.header,children:[t.jsxs("div",{style:r.logo,children:["Malu Editor ",t.jsx("span",{style:r.version,children:"v1.0.3"})]}),t.jsxs("button",{onClick:A,disabled:y||o,style:{...r.exportBtn,opacity:y||o?.5:1},children:[t.jsx(O,{}),y?"Exporting...":"Export"]})]}),t.jsxs("div",{style:r.workspace,children:[t.jsxs("div",{style:r.sidebar,children:[t.jsx("div",{style:r.sidebarItemActive,children:"Media"}),t.jsx("div",{style:r.sidebarItem,children:"Text"}),t.jsx("div",{style:r.sidebarItem,children:"Audio"})]}),t.jsxs("div",{style:r.centerStage,children:[t.jsx("div",{style:r.previewContainer,children:t.jsxs("div",{style:{...r.videoWrapper,aspectRatio:`${g.width}/${g.height}`},children:[t.jsx("video",{ref:e,src:p,controls:!1,crossOrigin:"anonymous",style:{...r.videoElement,opacity:o?0:1,zIndex:o?-1:1,pointerEvents:o?"none":"auto"},onEnded:P,onLoadedMetadata:M}),t.jsx("canvas",{ref:c,width:g.width,height:g.height,style:{...r.videoElement,backgroundColor:"#000",zIndex:5,opacity:o?1:0,pointerEvents:o?"auto":"none"}})]})}),t.jsxs("div",{style:r.timelineArea,children:[t.jsxs("div",{style:r.timelineControls,children:[t.jsx("button",{onClick:T,style:r.playBtn,children:o?t.jsx(Y,{}):t.jsx(V,{})}),t.jsx("span",{style:r.timeDisplay,children:X(I)})]}),t.jsxs("div",{style:r.timelineTrack,children:[t.jsx("div",{style:r.trackLabel,children:"Video 1"}),t.jsx("div",{style:r.trackContent,children:t.jsx("div",{style:r.clip,children:"Recording 001"})})]})]})]}),t.jsxs("div",{style:r.rightPanel,children:[t.jsx("h3",{style:r.panelTitle,children:"Properties"}),t.jsxs("div",{style:r.propertyGroup,children:[t.jsx("label",{style:r.label,children:"Zoom Intensity"}),t.jsx("input",{type:"range",min:"0",max:"100",style:r.range})]}),t.jsxs("div",{style:r.propertyGroup,children:[t.jsx("label",{style:r.label,children:"Background"}),t.jsxs("div",{style:{display:"flex",gap:8},children:[t.jsx("div",{style:{...r.colorSwatch,background:"linear-gradient(45deg, #0093E9, #80D0C7)"}}),t.jsx("div",{style:{...r.colorSwatch,background:"#333"}})]})]})]})]})]}):t.jsx("div",{style:r.loading,children:"No recording found."})}const X=c=>{const e=Math.floor(c/60),i=Math.floor(c%60);return`${e}:${i.toString().padStart(2,"0")}`},r={container:{display:"flex",flexDirection:"column",height:"100vh",background:"#1e1e1e",color:"#e0e0e0",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'},loading:{display:"flex",alignItems:"center",justifyContent:"center",height:"100vh",background:"#1e1e1e",color:"#fff"},header:{height:"50px",background:"#252526",borderBottom:"1px solid #333",display:"flex",alignItems:"center",justifyContent:"space-between",padding:"0 20px"},logo:{fontWeight:700,fontSize:"16px"},version:{fontSize:"10px",color:"#666",marginLeft:"5px",background:"#333",padding:"2px 4px",borderRadius:"4px"},exportBtn:{background:"#007AFF",color:"white",border:"none",borderRadius:"4px",padding:"6px 16px",display:"flex",alignItems:"center",gap:"6px",fontSize:"13px",fontWeight:600,cursor:"pointer"},workspace:{flex:1,display:"flex",overflow:"hidden"},sidebar:{width:"60px",background:"#252526",borderRight:"1px solid #333",display:"flex",flexDirection:"column",alignItems:"center",paddingTop:"10px"},sidebarItem:{width:"40px",height:"40px",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"10px",color:"#999",cursor:"pointer",marginBottom:"10px"},sidebarItemActive:{width:"40px",height:"40px",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"10px",color:"#fff",background:"#333",borderRadius:"8px",cursor:"pointer",marginBottom:"10px"},centerStage:{flex:1,display:"flex",flexDirection:"column",position:"relative"},previewContainer:{flex:1,background:"#1e1e1e",display:"flex",alignItems:"center",justifyContent:"center",padding:"20px",overflow:"hidden"},videoWrapper:{position:"relative",width:"100%",maxHeight:"100%",maxWidth:"100%",boxShadow:"0 10px 30px rgba(0,0,0,0.5)"},videoElement:{width:"100%",height:"100%",objectFit:"contain",position:"absolute",top:0,left:0},timelineArea:{height:"140px",background:"#252526",borderTop:"1px solid #333",display:"flex",flexDirection:"column"},timelineControls:{height:"40px",borderBottom:"1px solid #333",display:"flex",alignItems:"center",padding:"0 20px",gap:"10px"},playBtn:{background:"none",border:"none",color:"#fff",cursor:"pointer",display:"flex"},timeDisplay:{fontFamily:"monospace",fontSize:"12px",color:"#999"},timelineTrack:{flex:1,padding:"10px 20px",display:"flex",gap:"10px",overflowX:"auto"},trackLabel:{width:"60px",fontSize:"12px",color:"#999",paddingTop:"6px"},trackContent:{flex:1,position:"relative",background:"#1e1e1e",borderRadius:"4px",height:"40px"},clip:{position:"absolute",left:0,width:"100%",height:"100%",background:"#3A3A3C",border:"1px solid #007AFF",borderRadius:"4px",color:"#fff",fontSize:"11px",padding:"4px"},rightPanel:{width:"280px",background:"#252526",borderLeft:"1px solid #333",padding:"20px"},panelTitle:{fontSize:"12px",textTransform:"uppercase",color:"#999",marginBottom:"20px"},propertyGroup:{marginBottom:"20px"},label:{display:"block",fontSize:"12px",marginBottom:"8px",color:"#ccc"},range:{width:"100%"},colorSwatch:{width:"24px",height:"24px",borderRadius:"50%",border:"2px solid #fff",cursor:"pointer"}};D.createRoot(document.getElementById("root")).render(t.jsx(W.StrictMode,{children:t.jsx(U,{})}));
