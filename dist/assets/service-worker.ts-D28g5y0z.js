import{s as l}from"./index-CFZHzLVB.js";typeof chrome<"u"&&chrome.action&&chrome.action.onClicked.addListener(async e=>{e.id&&await chrome.tabs.create({url:`recorder.html?targetTabId=${e.id}`,active:!0,pinned:!0})});chrome.runtime.onMessage.addListener((e,T,n)=>{if(e.type==="BROADCAST_START"){const t=e.targetTabId;t&&(console.log(`Broadcasting START to tab ${t}`),(async()=>{var r,o,c;try{await chrome.tabs.sendMessage(t,{type:"START_RECORDING"})}catch(m){console.warn("Initial connect failed, attempting injection...",m);try{const i=(c=(o=(r=chrome.runtime.getManifest().content_scripts)==null?void 0:r[0])==null?void 0:o.js)==null?void 0:c[0];if(i){await chrome.scripting.executeScript({target:{tabId:t},files:[i]});let d=20;for(;d>0;)try{await chrome.tabs.sendMessage(t,{type:"START_RECORDING"}),console.log("Injection and handshake successful");return}catch{await new Promise(h=>setTimeout(h,50)),d--}throw new Error("Content script handshake timeout")}else console.error("Could not find content script in manifest")}catch(s){console.error("Failed to inject or retry content script",s)}}})())}if(e.type==="BROADCAST_STOP"){const t=e.targetTabId;if(t)return console.log(`Broadcasting STOP to tab ${t}`),(async()=>{try{const a=await new Promise(r=>{chrome.tabs.sendMessage(t,{type:"STOP_RECORDING"},o=>{chrome.runtime.lastError?(console.warn("Error fetching metadata:",chrome.runtime.lastError),r(null)):r(o)})});a&&a.data?(console.log("Metadata received via broadcast, saving...",a.data.length),await l("latest-metadata",a.data)):(console.log("No metadata received."),await l("latest-metadata",[])),n({success:!0})}catch(a){console.error("Error in BROADCAST_STOP handler:",a),n({success:!1})}})(),!0;console.warn("BROADCAST_STOP received but no targetTabId provided"),n({success:!1,error:"No targetTabId"})}});
