var I=Object.defineProperty;var M=(h,t,e)=>t in h?I(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var u=(h,t,e)=>M(h,typeof t!="symbol"?t+"":t,e);import"./modulepreload-polyfill-B5Qt9EMX.js";import{r as c,j as o,c as k,R as C}from"./client-D7f9BLy3.js";import{g as j}from"./index-CFZHzLVB.js";class L{constructor(t,e,i,a=null){u(this,"canvas");u(this,"video");u(this,"metadata");u(this,"ctx");u(this,"camera");u(this,"viewport",null);this.canvas=t,this.video=e,this.metadata=i.sort((l,n)=>l.timestamp-n.timestamp),this.viewport=a,this.ctx=t.getContext("2d"),this.camera={x:t.width/2,y:t.height/2,zoom:.9}}lerp(t,e,i){return t*(1-i)+e*i}getMousePosition(t){if(this.metadata.length===0)return null;let e=this.metadata[0],i=this.metadata[this.metadata.length-1];if(t<=e.timestamp)return{x:e.x,y:e.y};if(t>=i.timestamp)return{x:i.x,y:i.y};for(let s=0;s<this.metadata.length-1;s++)if(this.metadata[s].timestamp<=t&&this.metadata[s+1].timestamp>=t){e=this.metadata[s],i=this.metadata[s+1];break}const a=i.timestamp-e.timestamp;if(a===0)return{x:e.x,y:e.y};const l=(t-e.timestamp)/a;let n=this.lerp(e.x,i.x,l),m=this.lerp(e.y,i.y,l);if(this.viewport&&this.video.videoWidth>0){const s=this.video.videoWidth/this.viewport.width,g=this.video.videoHeight/this.viewport.height;n*=s,m*=g}return{x:n,y:m}}getTargetZoom(t){return this.metadata.find(i=>i.type==="click"&&Math.abs(i.timestamp-t)<800)?1.8:.9}clamp(t,e,i){return Math.max(e,Math.min(i,t))}drawBackground(){if(!this.ctx)return;const t=this.ctx.createLinearGradient(0,0,this.canvas.width,this.canvas.height);t.addColorStop(0,"#0093E9"),t.addColorStop(.5,"#80D0C7"),t.addColorStop(1,"#80D0C7"),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}draw(t){if(!this.ctx)return;this.drawBackground();const e=this.getMousePosition(t);this.ctx.save();let i,a;const l=this.getTargetZoom(t);if(this.camera.zoom=this.lerp(this.camera.zoom,l,.05),e){const n=this.canvas.width/this.camera.zoom,m=this.canvas.height/this.camera.zoom;if(this.camera.zoom<1)i=this.canvas.width/2,a=this.canvas.height/2;else{const s=n/2,g=this.canvas.width-n/2,v=m/2,y=this.canvas.height-m/2;i=this.clamp(e.x,s,g),a=this.clamp(e.y,v,y)}}else i=this.canvas.width/2,a=this.canvas.height/2;if(this.camera.x=this.lerp(this.camera.x,i,.08),this.camera.y=this.lerp(this.camera.y,a,.08),this.ctx.translate(this.canvas.width/2,this.canvas.height/2),this.ctx.scale(this.camera.zoom,this.camera.zoom),this.ctx.translate(-this.camera.x,-this.camera.y),this.video.readyState>=2&&(this.ctx.save(),this.ctx.shadowColor="rgba(0, 0, 0, 0.4)",this.ctx.shadowBlur=40,this.ctx.shadowOffsetY=20,this.ctx.drawImage(this.video,0,0,this.canvas.width,this.canvas.height),this.ctx.restore()),e){const n=24/(this.camera.zoom*.5+.5);this.ctx.shadowColor="rgba(0,0,0,0.3)",this.ctx.shadowBlur=8,this.ctx.shadowOffsetY=4,this.ctx.fillStyle="#FF4757",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,n,0,Math.PI*2),this.ctx.fill(),this.ctx.shadowColor="transparent",this.ctx.strokeStyle="white",this.ctx.lineWidth=3,this.ctx.stroke()}this.ctx.restore()}}function P(){var b;const h=c.useRef(null),t=c.useRef(null),e=c.useRef(null),i=c.useRef(),[a,l]=c.useState(!1),[n,m]=c.useState(""),[s,g]=c.useState(null),[v,y]=c.useState(!0),[x,S]=c.useState({width:1280,height:720});c.useEffect(()=>{(async()=>{var d;try{console.log("Loading data from IDB...");const f=await j("latest-video"),p=await j("latest-metadata");if(f){console.log(`Loaded Blob: ${f.size} bytes, type: ${f.type}`);const E=URL.createObjectURL(f);m(E)}else console.error("No blob found in IDB");p?(console.log(`Loaded Metadata: ${Array.isArray(p)?p.length:(d=p.events)==null?void 0:d.length} events`),g(p)):(console.warn("No metadata found, defaulting to empty"),g([]))}catch(f){console.error("Failed to load recording data",f)}finally{y(!1)}})()},[]);const R=()=>{if(t.current){const{videoWidth:r,videoHeight:d}=t.current;r&&d&&(console.log(`Video dimensions loaded: ${r}x${d}`),S({width:r,height:d}))}};c.useEffect(()=>{if(h.current&&t.current&&s){let r=[],d=null;Array.isArray(s)?r=s:s.events&&(r=s.events,d=s.viewport),console.log("Initializing Renderer with",r.length,"events. Viewport:",d),e.current=new L(h.current,t.current,r,d)}},[s,x]);const w=()=>{a&&e.current&&t.current&&(e.current.draw(t.current.currentTime*1e3),i.current=requestAnimationFrame(w))};c.useEffect(()=>(a&&(i.current=requestAnimationFrame(w)),()=>{i.current&&cancelAnimationFrame(i.current)}),[a]);const z=async()=>{if(t.current)try{a?t.current.pause():await t.current.play(),l(!a)}catch(r){console.error("Play failed:",r)}};return v?o.jsx("div",{children:"Loading recording..."}):n?o.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",padding:"20px"},children:[o.jsx("h1",{children:"Malu Editor"}),o.jsxs("div",{style:{background:"#eee",padding:"10px",marginBottom:"10px",fontSize:"12px",fontFamily:"monospace",border:"1px solid #ccc",width:"100%",maxWidth:"1000px"},children:[o.jsx("strong",{children:"Debug Info:"}),o.jsx("br",{}),"Metadata Events: ",s?Array.isArray(s)?s.length:(b=s.events)==null?void 0:b.length:"null",o.jsx("br",{}),"Video Dims: ",x.width," x ",x.height,o.jsx("br",{}),"IDB Check: ",s?"OK":"EMPTY"]}),o.jsxs("div",{style:{marginBottom:"10px",zIndex:100},children:[o.jsx("button",{onClick:z,style:{fontSize:"16px",padding:"8px 16px",cursor:"pointer"},children:a?"Stop & Edit":"Play Rendered"}),o.jsx("button",{style:{marginLeft:"10px",fontSize:"16px",padding:"8px 16px"},children:"Export"})]}),o.jsxs("div",{style:{position:"relative",border:"1px solid #ccc",width:1e3,maxWidth:"100%",aspectRatio:`${x.width}/${x.height}`,overflow:"hidden"},children:[o.jsx("video",{ref:t,src:n,controls:!0,crossOrigin:"anonymous",style:{width:"100%",height:"100%",objectFit:"contain",position:"absolute",top:0,left:0,opacity:a?0:1,zIndex:a?-1:1,pointerEvents:a?"none":"auto"},onEnded:()=>l(!1),onLoadedMetadata:R,onError:r=>console.error("Video error:",r)}),o.jsx("canvas",{ref:h,width:x.width,height:x.height,style:{width:"100%",height:"100%",objectFit:"contain",backgroundColor:"#000",position:"absolute",top:0,left:0,zIndex:5,opacity:a?1:0,pointerEvents:a?"auto":"none"}})]})]}):o.jsx("div",{children:"No recording found. Please record something first."})}k.createRoot(document.getElementById("root")).render(o.jsx(C.StrictMode,{children:o.jsx(P,{})}));
