import{s as f}from"./index-CFZHzLVB.js";async function l(e){return"getContexts"in chrome.runtime?(await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],documentUrls:[e]})).length>0:(await self.clients.matchAll()).some(n=>n.url.endsWith(e))}async function m(e){if(!await l(e))try{await chrome.offscreen.createDocument({url:e,reasons:[chrome.offscreen.Reason.USER_MEDIA],justification:"Recording from tab"})}catch(c){if(!c.message.startsWith("Only a single offscreen"))throw c}}let i=!1;function d(e,c=5e3){return new Promise(n=>{const t=o=>{o.type===e&&(chrome.runtime.onMessage.removeListener(t),n())};chrome.runtime.onMessage.addListener(t),setTimeout(()=>{chrome.runtime.onMessage.removeListener(t),n()},c)})}const u=async(e,c,n)=>{if(e.type==="GET_STATUS"){n({isRecording:i});return}if(e.type==="LOG"){const t=e.args||[];e.level==="error"?console.error("[OFFSCREEN]",...t):console.log("[OFFSCREEN]",...t);return}if(e.type==="OFFSCREEN_LOADED"){console.log("Offscreen loaded.");return}if(e.type!=="RECORDING_SAVED"){if(e.type==="START_RECORDING"){console.log("Starting recording sequence..."),i=!0;const t=e.tabId;if(!t){console.error("No target tab ID provided");return}typeof chrome<"u"&&chrome.offscreen&&(await m("src/offscreen/offscreen.html"),console.log("Offscreen document ensured."),await new Promise(r=>setTimeout(r,500)),chrome.tabCapture.getMediaStreamId({targetTabId:t},async r=>{if(!r){console.error("Failed to get MediaStreamId");return}console.log("Generated Stream ID:",r);try{await chrome.runtime.sendMessage({type:"START_RECORDING",target:"offscreen",streamId:r})}catch(s){console.warn("Failed to send message to offscreen:",s)}}),chrome.tabs.sendMessage(t,{type:"START_RECORDING"}).catch(r=>{console.log("Content script not ready",r)})),n({status:"started"})}else if(e.type==="STOP_RECORDING"){console.log("Stopping recording sequence..."),i=!1;try{await chrome.runtime.sendMessage({type:"STOP_RECORDING",target:"offscreen"})}catch(o){console.log("Failed to send stop to offscreen",o)}const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(t!=null&&t.id)try{const o=await new Promise((r,s)=>{chrome.tabs.sendMessage(t.id,{type:"STOP_RECORDING"},a=>{chrome.runtime.lastError?s(chrome.runtime.lastError):r(a==null?void 0:a.data)})});o?(console.log("Received metadata from content script, saving to IDB..."),await f("latest-metadata",o),console.log("Metadata saved to Extension IDB")):console.warn("No metadata received from content script")}catch(o){console.log("Failed to get metadata from content script",o)}if(typeof chrome<"u"&&chrome.offscreen){console.log("Waiting for Offscreen to save data..."),await d("RECORDING_SAVED");try{await chrome.offscreen.closeDocument(),console.log("Offscreen document closed.")}catch(o){console.log("No offscreen doc to close or error",o)}}n({status:"stopped"})}return!0}};typeof chrome<"u"&&chrome.runtime&&chrome.runtime.onMessage&&chrome.runtime.onMessage.addListener(u);export{u as handleMessage};
